{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import bootstrap_table_icons %}

{% block page_content %}
<div class="row gutters">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div id="networks-toolbar">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        {{ _("Export as") }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a id="button-export-all-included-ip-address" class="dropdown-item">{{ _("List of all included IP") }}</a></li>
                        </ul>
                    </div>
                </div>
                <table class="table"    id="networks-table"
                                        data-search="true"
                                        data-show-columns="true"
                                        data-show-toggle="true"
                                        data-show-export="true"
                                        data-show-multi-sort="true"
                                        data-filter-control="true"
                                        data-buttons-class="primary"
                                        data-pagination="true"
                                        data-side-pagination="server"
                                        data-show-pagination-switch="true"
                                        data-page-list="[10, 25, 50, 100, 500, All]"
                                        data-url="{{ url_for('networks.network_index_data', project_id=project.id) }}">
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block script %}
    {{ super() }}
    <script nonce="{{ csp_nonce() }}">
        $(function() {
            var hide_columns = new Set(JSON.parse(localStorage.getItem("NetworkIndexHideColumns")));
            if(hide_columns === null) {
                hide_columns = new Set();
            };
            $('#networks-table').bootstrapTable({
                onPreBody: function(data) {
                    var pageSizeData = localStorage.getItem("NetworkIndexPageSize");
                    if (pageSizeData != null) {
                        var pageSizeInt = parseInt(pageSizeData);
                        if(isNaN(pageSizeInt)) {
                            pageSizeInt = 500;
                        }
                        this.pageSize = pageSizeInt;
                    }
                },
                onPageChange: function(pageNumber, pageSize) {
                    localStorage.setItem("NetworkIndexPageSize", pageSize)
                },
                onLoadSuccess: function(data) {
                    $('#networks-table > tbody > tr').mousedown(event => {
                        if(event.button === 1) {
                            window.open("{{ url_for('networks.network_show', network_id='__network_id') }}".replace("__network_id", $(event.currentTarget).parent().parent().bootstrapTable('getData')[$(event.currentTarget).data('index')].id), "_blank");
                        };
                     });
                },
                onColumnSwitch: function(field, checked) {
                    var hide_columns = new Set(JSON.parse(localStorage.getItem("NetworkIndexHideColumns")));
                    if(checked) {
                        hide_columns.delete(field);
                        localStorage.setItem("NetworkIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                    }
                    else {
                        hide_columns.add(field);
                        localStorage.setItem("NetworkIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                    };
                },
                rowStyle: (row, index) => {
                    return { classes: "with-context-menu-networks", css: {"cursor": 'pointer' } }
                },
                filterControl: true,
                disableUnusedSelectOptions: true,
                columns: [
                {
                    field: 'id',
                    title: '#',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('id')),
                },
                {
                    field: 'title',
                    title: '{{ models.Network.title.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('title')),
                },
                {
                    field: 'description',
                    title: '{{ models.Network.description.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('description')),
                },
                {
                    field: 'ip_address',
                    title: '{{ models.Network.ip_address.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('ip_address')),
                },
                {
                    field: 'internal_ip',
                    title: '{{ models.Network.internal_ip.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('internal_ip')),
                },
                {
                    field: 'asn',
                    title: '{{ models.Network.asn.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('asn')),
                },
                {
                    field: 'connect_cmd',
                    title: '{{ models.Network.connect_cmd.info["label"] }}',
                    sortable: true,
                    align: 'center',
                    filterControl: 'input',
                    visible: !(hide_columns.has('connect_cmd')),
                }
                ],
                icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                showColumns: true,
                detailView: true,
                onClickRow: function(row, element, field) {
                    location = "{{ url_for('networks.network_show', network_id='__row_id') }}".replace("__row_id", row.id)
                },
                onExpandRow: function (index, row, $detail) {
                    var hide_columns = new Set(JSON.parse(localStorage.getItem("HostByNetworkIndexHideColumns")));
                    if(hide_columns === null) {
                        hide_columns = new Set();
                    };
                    $detail.html('<table class="hosts-table"></table>').find('table').bootstrapTable({
                        onPreBody: function(data) {
                            var pageSizeData = localStorage.getItem("HostByNetworkPageSize");
                            if (pageSizeData != null) {
                                var pageSizeInt = parseInt(pageSizeData);
                                if(isNaN(pageSizeInt)) {
                                    pageSizeInt = 500;
                                }
                                this.pageSize = pageSizeInt;
                            }
                        },
                        onPageChange: function(pageNumber, pageSize) {
                            localStorage.setItem("HostByNetworkPageSize", pageSize)
                        },
                        onLoadSuccess: function(data) {
                            $('.hosts-table > tbody > tr').mousedown(event => { 
                                if(event.button === 1) {
                                    window.open("{{ url_for('networks.host_show', host_id='__host_id') }}".replace("__host_id", event.currentTarget.children[1].innerHTML), "_blank");
                                };
                             });
                        },
                        onColumnSwitch: function(field, checked) {
                            var hide_columns = new Set(JSON.parse(localStorage.getItem("HostByNetworkIndexHideColumns")));
                            if(checked) {
                                hide_columns.delete(field);
                                localStorage.setItem("HostByNetworkIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                            }
                            else {
                                hide_columns.add(field);
                                localStorage.setItem("HostByNetworkIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                            };
                        },
                        columns: [
                        {
                            field: "id",
                            title: "#",
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('id')),
                        },
                        {
                            field: 'title',
                            title: '{{ models.Host.title.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('title')),
                        },
                        {
                            field: 'description',
                            title: '{{ models.Host.description.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('description')),
                        },
                        {
                            field: 'ip_address',
                            title: '{{ models.Host.ip_address.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('ip_address')),
                        },
                        {
                            field: 'mac',
                            title: '{{ models.Host.mac.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('mac')),
                        },
                        {
                            field: 'operation_system_family',
                            title: '{{ models.Host.operation_system_family.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'select',
                            filterData: 'json:{{ filters["OperationSystemFamily"]|escapejs }}',
                            visible: !(hide_columns.has('operation_system_family')),
                        },
                        {
                            field: 'operation_system_gen',
                            title: '{{ models.Host.operation_system_gen.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'input',
                            visible: !(hide_columns.has('operation_system_gen')),
                        },
                        {
                            field: 'device_type',
                            title: '{{ models.Host.device_type.info["label"] }}',
                            sortable: true,
                            align: 'center',
                            filterControl: 'select',
                            filterData: 'json:{{ filters["DeviceType"]|escapejs }}',
                            visible: !(hide_columns.has('device_type')),
                        },
                        {
                            field: 'device_vendor',
                            title: '{{ models.Host.device_vendor.info["label"] }}',
                            sortable: true,
                            align: 'center', 
                            filterControl: 'select',
                            filterData: 'json:{{ filters["DeviceVendor"]|escapejs }}',
                            visible: !(hide_columns.has('device_vendor')),
                        }
                        ],
                        showColumns: true,
                        search: true,
                        showToggle: true,
                        showExport: true,
                        showMultiSort: true,
                        filterControl: true,
                        buttonsClass: 'primary',
                        pagination: true,
                        sidePagination: 'server',
                        url: '{{ url_for("networks.host_by_network_data", network_id="__row_id") }}'.replace('__row_id', row.id),
                        rowStyle: (row, index) => {
                            return { css: {"cursor": 'pointer' } }
                        },
                        icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                        onClickRow: function(row, element, field) {
                                location = "{{ url_for('networks.host_show', host_id='__row_id') }}".replace("__row_id", row.id)
                            },
                        detailView: true,
                        onExpandRow: function (index, row, $detail) {
                            var hide_columns = new Set(JSON.parse(localStorage.getItem("ServicesByHostIndexHideColumns")));
                            if(hide_columns === null) {
                                hide_columns = new Set();
                            };
                            $detail.html('<table></table>').find('table').bootstrapTable({
                                onPreBody: function(data) {
                                    var pageSizeData = localStorage.getItem("ServicesByHostIndexPageSize");
                                    if (pageSizeData != null) {
                                        var pageSizeInt = parseInt(pageSizeData);
                                        if(isNaN(pageSizeInt)) {
                                            pageSizeInt = 500;
                                        }
                                        this.pageSize = pageSizeInt;
                                    }
                                },
                                onPageChange: function(pageNumber, pageSize) {
                                    localStorage.setItem("ServicesByHostIndexPageSize", pageSize)
                                },
                                onColumnSwitch: function(field, checked) {
                                    var hide_columns = new Set(JSON.parse(localStorage.getItem("ServicesByHostIndexHideColumns")));
                                    if(checked) {
                                        hide_columns.delete(field);
                                        localStorage.setItem("ServicesByHostIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                                    }
                                    else {
                                        hide_columns.add(field);
                                        localStorage.setItem("ServicesByHostIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                                    };
                                },
                                columns: [
                                {
                                    field: 'id',
                                    title: '#',
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'input',
                                    visible: !(hide_columns.has('id')),
                                },
                                {
                                    field: 'title',
                                    title: '{{ models.Service.title.info["label"] }}',
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'input',
                                    visible: !(hide_columns.has('title')),
                                },
                                {
                                    field: 'port',
                                    title: '{{ models.Service.port.info["label"] }}',
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'input',
                                    visible: !(hide_columns.has('port')),
                                },
                                {
                                    field: 'access_protocol.title-input',
                                    title: '{{ models.Service.access_protocol.info["label"] }}',
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'input',
                                    visible: !(hide_columns.has('access_protocol.title-input')),
                                },
                                {
                                    field: 'transport_level_protocol',
                                    title: '{{ models.Service.transport_level_protocol.info["label"] }}',
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'select',
                                    filterData: 'json:{{ filters["ServiceTransportLevelProtocol"]|escapejs }}',
                                    visible: !(hide_columns.has('transport_level_protocol')),
                                },
                                {
                                    field: 'port_state',
                                    title: "{{ models.Service.port_state.info['label'] }}",
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'select',
                                    filterData: 'json:{{ filters["ServicePortState"]|escapejs }}',
                                    visible: !(hide_columns.has('port_state')),
                                },
                                {
                                    field: 'port_state_reason',
                                    title: "{{ models.Service.port_state_reason.info['label'] }}",
                                    sortable: true,
                                    align: 'center',
                                    filterControl: 'input',
                                    visible: !(hide_columns.has('port_state_reason')),
                                }
                                ],
                                showColumns: true,
                                search: true,
                                showToggle: true,
                                showExport: true,
                                showMultiSort: true,
                                filterControl: true,
                                buttonsClass: 'primary',
                                pagination: true,
                                sidePagination: 'server',
                                url: '{{ url_for("networks.service_by_host_data", host_id="__host_id") }}'.replace('__host_id', row.id),
                                rowStyle: (row, index) => {
                                    return { css: {"cursor": 'pointer' } }
                                },
                                icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                                onClickRow: function(row, element, field) {
                                    location = "{{ url_for('networks.service_show', service_id='__row_id') }}".replace("__row_id", row.id)
                                }
                            })
                        }
                    }) 
                }
            })
        });
        $(function () {
            $.contextMenu({
                selector: '.with-context-menu-networks',
                callback: function (key, options) {
                    if (key === 'open') {
                        window.open("{{ url_for('networks.network_show', network_id='__network_id') }}".replace("__network_id", options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank')
                    }
                    else if(key === 'edit') {
                        window.open("{{ url_for('networks.network_edit', network_id='__network_id') }}".replace('__network_id', options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank').focus()
                    }
                },
                items: {
                    "open": { name: '{{ _("Open in new tab") }}', icon: "filescroll" },
                    "edit": { name: '{{ _("Edit") }}' , icon: "edit"},
                }
            });
        });
        document.getElementById('button-export-all-included-ip-address').addEventListener('click', function() {
            var table_data = $('#networks-table').bootstrapTable('togglePagination').bootstrapTable('getData');
            $('#networks-table').bootstrapTable('togglePagination');
            let now_ids = [];
            table_data.forEach(item => now_ids.push(item.id));
            var search_params = new URLSearchParams();
            search_params.set('project_id', "{{ project.id }}");
            search_params.set("network_ids", now_ids.join(','));
            window.location = "{{ url_for('networks.generate_all_included_ip_addresses') }}?" + search_params.toString();
        })
      </script>
{% endblock %}