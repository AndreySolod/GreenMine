{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import bootstrap_table_icons %}

{% block page_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>{{ _("List all research events") }}</h5>
                </div>
                <div class="card-body">
                    <table class="table" id="pentest-research-events-table" data-pagination="true" data-search="true"
                                        data-show-columns="true" data-show-toggle="true" data-show-export="true" data-show-multi-sort="true"
                                        data-filter-control="true" data-buttons-class="primary" data-show-pagination-switch="true"
                                        data-cookie="true"
                                        data-cookie-id-table="PentestResearchEventIndex"
                                        data-cookie-storage="localStorage">
                        <thead>
                            <tr>
                                <th data-field="id" data-sortable="true" data-align="center">{{ models.PentestResearchEvent.id.info['label'] }}</th>
                                <th data-field="title" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.title.info['label'] }}</th>
                                <th data-field="created_by" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.created_by.info['label'] }}</th>
                                <th data-field="timestamp" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.timestamp.info['label'] }}</th>
                                <th data-field="source_host" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.source_host.info['label'] }}</th>
                                <th data-field="source_user" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.source_user.info['label'] }}</th>
                                <th data-field="source_process" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.source_process.info['label'] }}</th>
                                <th data-field="target_host" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.target_host.info['label'] }}</th>
                                <th data-field="target_user" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.target_user.info['label'] }}</th>
                                <th data-field="target_process" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.target_process.info['label'] }}</th>
                                <th data-field="operator" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.operator.info['label'] }}</th>
                                <th data-field="description" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.description.info['label'] }}</th>
                                <th data-field="raw_evidence" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.raw_evidence.info['label'] }}</th>
                                <th data-field="detected" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.detected.info['label'] }}</th>
                                <th data-field="prevented" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.prevented.info['label'] }}</th>
                                <th data-field="mitre_attack_tactic" data-sortable="true" data-align="center" data-filter-control="select">{{ _("MITRE ATT&CK Tactic") }}</th>
                                <th data-field="mitre_attack_technique" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.mitre_attack_technique.info['label'] }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in events %}
                            <tr style="cursor: pointer">
                                <td>{{ e.id }}</td>
                                <td>{{ e.title|suppress_none }}</td>
                                <td>{{ e.created_by.title|suppress_none }}</td>
                                <td>{{ moment(e.timestamp).format('LLLL') }}</td>
                                <td>{{ e.source_host.fulltitle|default("", True) }}</td>
                                <td>{{ e.source_user|suppress_none }}</td>
                                <td>{{ e.source_process|suppress_none }}</td>
                                <td>{{ e.target_host.fulltitle|default("", True) }}</td>
                                <td>{{ e.target_user|suppress_none }}</td>
                                <td>{{ e.target_process|suppress_none }}</td>
                                <td>{{ e.operator.title|default("", True) }}</td>
                                <td>{{ sanitizer.pure_text(e.description) }}</td>
                                <td>{{ sanitizer.pure_text(e.raw_evidence) }}</td>
                                <td>{{ e.detected.title|default("", True) }}</td>
                                <td>{{ e.prevented.title|default("", True) }}</td>
                                {% if e.mitre_attack_technique != none %}
                                <td>{{ e.mitre_attack_technique.tactic.title|default("", True) }}</td>
                                {% else %}
                                <td></td>
                                {% endif %}
                                <td>{{ e.mitre_attack_technique.title|default("", True) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script nonce="{{ csp_nonce() }}">
    $(function() {
        $('#pentest-research-events-table').bootstrapTable({ 
            icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
            buttonsClass: 'primary',
            exportTypes: ['json', 'xml', 'png', 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],
            onClickRow: function(row, element, field) {
                location = "{{ url_for('pentest_events.researcher_event_show', event_id='__row_id') }}".replace("__row_id", row.id)
            }
         });
    });
</script>
{% endblock %}