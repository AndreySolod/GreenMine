{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import object_comments, object_history, load_bootstrap_table_js %}

{% block page_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ event.title|suppress_none }}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td>{{ models.PentestResearchEvent.timestamp.info['label'] }}:</td>
                                <td>{{ moment(event.timestamp).format('LLLL') }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.detected.info['label'] }}:</td>
                                <td>{{ event.detected.title|suppress_none }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.prevented.info['label'] }}:</td>
                                <td>{{ event.prevented.title|suppress_none }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.MitreAttackTactic.Meta.verbose_name }}:</td>
                                {% if event.mitre_attack_technique != none %}
                                <td>{{ event.mitre_attack_technique.tactic.title|default("", True) }}</td>
                                {% else %}
                                <td></td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.mitre_attack_technique.info['label'] }}:</td>
                                <td>{{ event.mitre_attack_technique.title|default("", True) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ _("Event paramethers") }}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td>{{ models.PentestResearchEvent.operator.info['label'] }}:</td>
                                {% if event.operator_id != none %}
                                <td><a href="{{ url_for('users.user_show', user_id=event.operator_id) }}">{{ event.operator.title|suppress_none }}</a></td>
                                {% else %}
                                <td></td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.source_host.info['label'] }}:</td>
                                {% if event.source_host_id != none %}
                                <td><a href="{{ url_for('networks.host_show', host_id=event.source_host_id) }}">{{ event.source_host.fulltitle|suppress_none }}</a></td>
                                {% else %}
                                <td></td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.source_user.info['label'] }}:</td>
                                <td>{{ event.source_user|suppress_none }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.source_process.info['label'] }}:</td>
                                <td>{{ event.source_process|suppress_none }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.target_host.info['label'] }}:</td>
                                {% if event.target_host_id != none %}
                                <td><a href="{{ url_for('networks.host_show', host_id=event.target_host_id) }}">{{ event.target_host.fulltitle|suppress_none }}</a></td>
                                {% else %}
                                <td></td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.target_user.info['label'] }}:</td>
                                <td>{{ event.target_user|suppress_none }}</td>
                            </tr>
                            <tr>
                                <td>{{ models.PentestResearchEvent.target_process.info['label'] }}:</td>
                                <td>{{ event.target_process|suppress_none }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ models.PentestResearchEvent.follow_from_events.info['label'] }}</h5>
                </div>
                <div class="card-body">
                    <table class="table" id="follow-from-events-table" data-show-columns="true" data-show-toggle="true" data-filter-control="true" data-button-class="primary" data-cookie="true"
                                 data-cookie-id-table="PentestResearchEventFollowFromEventsTable" data-cookie-storage="localStorage" data-row-style="default_row_style">
                        <thead>
                            <tr>
                                <th data-field="id" data-sortable="true" data-align="center">{{ models.PentestResearchEvent.id.info['label'] }}</th>
                                <th data-field="title" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.title.info['label'] }}</th>
                                <th data-field="description" data-sortable="true" data-align="center" data-filter-control="input">{{ models.PentestResearchEvent.description.info['label'] }}</th>
                                <th data-field="detected" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.detected.info['label'] }}</th>
                                <th data-field="prevented" data-sortable="true" data-align="center" data-filter-control="select">{{ models.PentestResearchEvent.prevented.info['label'] }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prev_evt in event.follow_from_events %}
                            <tr>
                                <td>{{ prev_evt.id }}</td>
                                <td>{{ prev_evt.title|suppress_none }}</td>
                                <td>{{ sanitizer.pure_text(prev_evt.description) }}</td>
                                <td>{{ prev_evt.detected.title }}</td>
                                <td>{{ prev_evt.prevented.title }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ models.PentestResearchEvent.description.info['label'] }}:</h5>
                </div>
                <div class="card-body">
                    {% if event.description != '' and event.description != none %}
                    {{ event.description|safe }}
                    {% else %}
                    <p class="text-center text-muted">{{ pgettext("other", "(Missing)") }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ models.PentestResearchEvent.raw_evidence.info["label"] }}:</h5>
                </div>
                <div class="card-body">
                    {% if event.raw_evidence != '' and event.raw_evidence != none %}
                    {{ event.raw_evidence|safe }}
                    {% else %}
                    <p class="text-center text-muted">{{ pgettext("other", "(Missing)") }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs" id="CommentAndHistoryTab" role="tablist">
                        {% set first_tab = " active" %}
                        {% if roles.project_role_can_make_action(current_user, event, 'show_comments') %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link{{ first_tab }}" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments"
                                type="button" role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-list"></i>
                                {{ _("Comments") }}</button>
                        </li>
                        {% set first_tab = '' %}
                        {% endif %}
                        {% if roles.project_role_can_make_action(current_user, event, 'show_history') %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link{{ first_tab }}" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                                role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-grip"></i>
                                {{ _("History of property changes") }}</button>
                        </li>
                        {% set first_tab = '' %}
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="CommentAndHistoryTabContent">
                        {% set first_tab = ' show active' %}
                        {% if roles.project_role_can_make_action(current_user, event, 'show_comments') %}
                        <div class="tab-pane fade{{ first_tab }}" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                            {{ object_comments(event, moment, comment_form, current_user, roles) }}
                        </div>
                        {% set first_tab = '' %}
                        {% endif %}
                        {% if roles.project_role_can_make_action(current_user, event, 'show_history') %}
                        <div class="tab-pane fade{{ first_tab }}" id="history" role="tabpanel" aria-labelledby="history-tab">
                            {{ object_history(event, moment, current_user) }}
                        </div>
                        {% set first_tab = '' %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
{{ load_bootstrap_table_js("follow-from-events-table", "pentest_events.researcher_event_show", "event_id") }}
<script nonce="{{ csp_nonce() }}">
    function default_row_style(row, index) {
    return {css: { cursor: 'pointer' }}
  }
</script>
{% endblock %}