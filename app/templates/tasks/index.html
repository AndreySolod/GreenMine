{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import bootstrap_table_icons %}

{% block page_content %}
<div class="row gutters">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <table class="table"    id="task-table"
                                        data-search="true"
                                        data-show-columns="true"
                                        data-show-toggle="true"
                                        data-show-export="true"
                                        data-show-multi-sort="true"
                                        data-filter-control="true"
                                        data-buttons-class="primary"
                                        data-pagination="true"
                                        data-side-pagination="server"
                                        data-show-pagination-switch="true"
                                        data-page-list="[10, 25, 50, 100, 500, All]"
                                        data-url="{{ url_for('tasks.projecttask_index_data', project_id=project.id) }}"
                                        data-row-style="tasksRowStyle">
                </table>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block script %}
    {{ super() }}
    <script nonce="{{ csp_nonce() }}">
        var hide_columns = new Set(JSON.parse(localStorage.getItem("ProjectTaskIndexHideColumns"))); // -> Set('title')
          if(hide_columns === null) {
            hide_columns = new Set();
          };
        $(function() {
            $('#task-table').bootstrapTable({
                columns: [
                {
                    field: 'id',
                    title: '#',
                    align: 'center',
                    sortable: true,
                    visible: !(hide_columns.has('id')),
                },
                {
                    field: 'tracker',
                    title: "{{ models.ProjectTask.tracker.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["ProjectTaskTracker"]|escapejs }}',
                    visible: !(hide_columns.has('tracker')),
                },
                {
                    field: 'title',
                    title: '{{ models.ProjectTask.title.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    visible: !(hide_columns.has('title')),
                },
                {
                    field: 'description',
                    title: '{{ models.ProjectTask.description.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    visible: !(hide_columns.has('description')),
                },
                {
                    field: 'priority',
                    title: '{{ models.ProjectTask.priority.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["ProjectTaskPriority"]|escapejs }}',
                    visible: !(hide_columns.has('priority')),
                },
                {
                    field: 'assigned_to',
                    title: "{{ models.ProjectTask.assigned_to.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["User"]|escapejs }}',
                    visible: !(hide_columns.has('assigned_to')),
                },
                {
                    field: 'readiness',
                    title: "{{ models.ProjectTask.readiness.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    visible: !(hide_columns.has('readiness')),
                },
                {
                    field: 'state',
                    title: "{{ models.ProjectTask.state.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["TaskState"]|escapejs }}',
                    visible: !(hide_columns.has('state')),
                }
                ],
                onPreBody: function(data) {
                    var pageSizeData = localStorage.getItem("ProjectTaskIndexPageSize");
                    if (pageSizeData != null) {
                        var pageSizeInt = parseInt(pageSizeData);
                        if(isNaN(pageSizeInt)) {
                            pageSizeInt = 500;
                        }
                        this.pageSize = pageSizeInt;
                    }
                },
                onPageChange: function(pageNumber, pageSize) {
                    localStorage.setItem("ProjectTaskIndexPageSize", pageSize)
                },
                onColumnSwitch: function(field, checked) {
                    var hide_columns = new Set(JSON.parse(localStorage.getItem("ProjectTaskIndexHideColumns")));
                    if(checked) {
                        hide_columns.delete(field);
                        localStorage.setItem("ProjectTaskIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                    }
                    else {
                        hide_columns.add(field);
                        localStorage.setItem("ProjectTaskIndexHideColumns", JSON.stringify(Array.from(hide_columns)));
                    };
                },
                icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                buttonsClass: 'primary',
                exportTypes: ['json', 'xml', 'png', 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],
                onClickRow: function(row, element, field) {
                    location = "{{ url_for('tasks.projecttask_show', projecttask_id='__row_id') }}".replace("__row_id", row.id)
                }
            })
          });
    </script>
    <script nonce="{{ csp_nonce() }}">
        function tasksRowStyle(row, index) {
            return { classes: "with-context-menu-task", css: {"cursor": 'pointer', 'background-color': row.background_color} }
        }
        $(function () {
            $.contextMenu({
                selector: '.with-context-menu-task',
                callback: function (key, options) {
                    if (key === 'open') {
                        window.open("{{ url_for('tasks.projecttask_show', projecttask_id='__task_id') }}".replace("__task_id", options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank')
                    }
                    else if(key === 'edit') {
                        window.open("{{ url_for('tasks.projecttask_edit', projecttask_id='__task_id') }}".replace('__task_id', options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank').focus()
                    }
                },
                items: {
                    "open": { name: '{{ _("Open in new tab") }}', icon: "filescroll" },
                    "edit": { name: '{{ _("Edit") }}' , icon: "edit"},
                }
            });
        });
      </script>
{% endblock %}