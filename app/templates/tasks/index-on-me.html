{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import bootstrap_table_icons %}

{% block page_content %}
<div class="row gutters">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <table    id="task-table"
                                        data-search="true"
                                        data-show-columns="true"
                                        data-show-toggle="true"
                                        data-show-export="true"
                                        data-show-multi-sort="true"
                                        data-filter-control="true"
                                        data-buttons-class="primary"
                                        data-pagination="true"
                                        data-side-pagination="server"
                                        data-page-list="[10, 25, 50, 100, 500, All]"
                                        data-show-pagination-switch="true"
                                        data-url="{{ url_for('tasks.projecttask_index_on_me_data', project_id=project.id) }}"
                                        data-cookie="true"
                                        data-cookie-id-table="ProjectTaskIndexOnMe"
                                        data-cookie-storage="localStorage">
                </table>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block script %}
    {{ super() }}
    <script nonce="{{ csp_nonce() }}">
        $(function() {
            $('#task-table').bootstrapTable({
                columns: [
                {
                    field: 'id',
                    title: '#',
                    align: 'center',
                    sortable: true,
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'tracker',
                    title: "{{ models.ProjectTask.tracker.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["ProjectTaskTracker"]|escapejs }}',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'title',
                    title: '{{ models.ProjectTask.title.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'description',
                    title: '{{ models.ProjectTask.description.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'priority',
                    title: '{{ models.ProjectTask.priority.info["label"] }}',
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["ProjectTaskPriority"]|escapejs }}',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'assigned_to',
                    title: "{{ models.ProjectTask.assigned_to.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["User"]|escapejs }}',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'readiness',
                    title: "{{ models.ProjectTask.readiness.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'input',
                    cellStyle: tasksCellStyle
                },
                {
                    field: 'state',
                    title: "{{ models.ProjectTask.state.info['label'] }}",
                    align: 'center',
                    sortable: true,
                    filterControl: 'select',
                    filterData: 'json:{{ filters["TaskState"]|escapejs }}',
                    cellStyle: tasksCellStyle
                }
                ],
                icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                buttonsClass: 'primary',
                exportTypes: ['json', 'xml', 'png', 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],
                onDblClickRow: function(row, element, field) {
                    location = "{{ url_for('tasks.projecttask_show', projecttask_id='__row_id') }}".replace("__row_id", row.id)
                },
                rowStyle: (value, row, index) => {
                    return { classes: "with-context-menu-task", css: {"cursor": 'pointer', 'background-color': row.row_background_color} }
                }
            })
          });
        function tasksCellStyle(value, row, index, field) {
            if(field !== "state") {
                return { css: {"cursor": 'pointer', 'background-color': row.row_background_color} };
            }
            else {
                return { css: {"cursor": 'pointer', 'background-color': row.task_background_color, 'color': row.task_text_color} };
            }
        };
        $(function () {
            $.contextMenu({
                selector: '.with-context-menu-task',
                callback: function (key, options) {
                    if (key === 'open') {
                        window.open("{{ url_for('tasks.projecttask_show', projecttask_id='__task_id') }}".replace("__task_id", options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank')
                    }
                    else if(key === 'edit') {
                        window.open("{{ url_for('tasks.projecttask_edit', projecttask_id='__task_id') }}".replace('__task_id', options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id), '_blank').focus()
                    }
                    else if (key === 'delete') {
                        if (confirm("{{ _('Are you sure you want to delete this task?') }}")) {
                            let task_id = options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id;
                            fetch("{{ url_for('tasks.projecttask_delete', projecttask_id='__task_id') }}".replace('__task_id', task_id), {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                }
                            }).then(response => {
                                if (response.redirected) {
                                    document.location = response.url;
                                }
                            });
                        };
                    }
                },
                items: {
                    "open": { name: '{{ _("Open in new tab") }}', icon: "filescroll" },
                    "edit": { name: '{{ _("Edit") }}' , icon: "edit"},
                    "delete": { name: '{{ _("Delete") }}' , icon: "delete"}
                }
            });
        });
      </script>
{% endblock %}