{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import object_comments, object_history, load_bootstrap_table_js, form_element %}

{% block page_content %}
<div class="row gutters">
    <div class="col-lg-6 col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>{{ _("Basic information") }}:</h4>
            </div>
            <div class="card-body">
                <div class="row gutters">
                    <div class="col-12">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td>{{ models.Credential.login.info['label'] }}:</td>
                                    <td>{{ credential.login|safe }}</td>
                                </tr>
                                <tr>
                                    <td>{{ models.Credential.password_hash.info['label'] }}:</td>
                                    <td>{{ credential.password_hash|safe }}</td>
                                </tr>
                                <tr>
                                    <td>{{ models.Credential.hash_type.info['label'] }}:</td>
                                    <td>{{ credential.hash_type.title }}</td>
                                </tr>
                                {% if credential.hash_type is not none %}
                                <tr>
                                    <td>{{ credential.hash_type.__class__.hashcat_mode.info['label'] }}:</td>
                                    <td>{{ credential.hash_type.hashcat_mode }}</td>
                                </tr>
                                <tr>
                                    <td>{{ credential.hash_type.__class__.john_mode.info['label'] }}:</td>
                                    <td>{{ credential.hash_type.john_mode }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td>{{ models.Credential.check_wordlist.info['label'] }}:</td>
                                    <td>{{ credential.check_wordlist.title }}</td>
                                </tr>
                                <tr>
                                    <td>{{ models.Credential.password.info['label'] }}:</td>
                                    <td>{{ credential.password|safe }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-md-12">
        {% if roles.project_role_can_make_action(current_user, models.Service(), 'index', project=credential.project) %}
        <div class="card">
            <div class="card-header">
                <h4>{{ models.Credential.services.info["label"] }}:</h4>
            </div>
            <div class="card-body">
                <div class="row gutters">
                    <div class="col-12">
                        <div id="services-toolbar">
                        {% if roles.project_role_can_make_action(current_user, credential, 'update') %}
                        <button class="btn btn-primary btn-rounded" data-bs-toggle="modal" data-bs-target="#modalEditRelatedServices" data-toggle="tooltip" data-placement="top" title="{{ _('Edit related services') }}"><i class="fa-solid fa-link"></i></button>
                        {% endif %}
                        </div>
                        <table class="table" id="services-table"
                                             data-page-size="5"
                                             data-toolbar="#services-toolbar"
                                             data-pagination="true"
                                             data-search="true"
                                             data-show-columns="true"
                                             data-show-toggle="true"
                                             data-show-export="true"
                                             data-show-multi-sort="true"
                                             data-filter-control="true"
                                             data-buttons-class="primary"
                                             data-row-style="default_row_style"
                                             data-cookie="true"
                                             data-cookie-id-table="ServicesByCredentialIndex"
                                             data-cookie-storage="localStorage">
                            <thead>
                                <tr>
                                    <th data-field="id" data-sortable="true" data-align="center">{{ models.Service.id.info["label"] }}</th>
                                    <th data-field="title" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Service.title.info["label"] }}</th>
                                    <th data-field="ip_address" data-sortable="true" data-align="center" data-filter-control="select">{{ models.Host.ip_address.info["label"] }}</th>
                                    <th data-field="port" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Service.port.info["label"] }}</th>
                                    <th data-field="transport_level_protocol" data-sortable="true" data-align="center" data-filter-control="select">{{ models.Service.transport_level_protocol.info["label"] }}</th>
                                    <th data-field="access_protocol" data-sortable="true" data-align="center" data-filter-control="select">{{ models.Service.access_protocol.info["label"] }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in credential.services %}
                                <tr style="cursor:pointer;">
                                    <td>{{ service.id }}</td>
                                    <td>{{ service.title|safe }}</td>
                                    <td>{{ service.host.ip_address }}</td>
                                    <td>{{ service.port|safe }}</td>
                                    <td>{{ service.transport_level_protocol.title }}</td>
                                    <td>{{ service.access_protocol.title }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="col-lg-6 col-md-12 col-12">
        <div class="card">
            <div class="card-header">
                <h4>{{ models.Credential.description.info['label'] }}</h4>
            </div>
            <div class="card-body">
                {% autoescape false %}
                {{ credential.description }}
                {% endautoescape %}
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    {% set first_tab = False %}
                    {% if roles.project_role_can_make_action(current_user, credential, 'show_comments') %}
                    {% set first_tab = True %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments"
                            type="button" role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-list"></i>
                            {{ _("Comments") }}</button>
                    </li>
                    {% endif %}
                    {% if roles.project_role_can_make_action(current_user, credential, 'show_history') %}
                    {% if first_tab %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                            role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-grip"></i>
                            {{ _("History of property changes") }}</button>
                    </li>
                    {% else %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                            role="tab" aria-controls="home" aria-selected="true"><i class="fa-solid fa-grip"></i>
                            {{ _("History of property changes") }}</button>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="myTabContent">
                    {% if roles.project_role_can_make_action(current_user, credential, 'show_comments') %}
                    <div class="tab-pane fade show active" id="comments" role="tabpanel" aria-labelledby="comments-tab">
                        {{ object_comments(credential, moment, comment_form, current_user, roles) }}
                    </div>
                    {% endif %}
                    {% if roles.project_role_can_make_action(current_user, credential, 'show_history') %}
                    {% if first_tab %}
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                      {{ object_history(credential, moment, current_user) }}
                    </div>
                    {% else %}
                    <div class="tab-pane fade show active" id="history" role="tabpanel" aria-labelledby="history-tab">
                        {{ object_history(credential, moment, current_user) }}
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# modal window to edit related services #}
{% if roles.project_role_can_make_action(current_user, credential, 'update') %}
<div class="modal fade modal-xl" id="modalEditRelatedServices" tabindex="-1" aria-labelledby="modalEditRelatedServicesLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="modalEditRelatedServicesLabel">{{ _("Edit related services") }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="col-12 position-relative">
          <div class="form-group">
            {{ form_element(edit_related_services, edit_related_services.services) }}
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="edit_related_services" class="btn btn-primary">{{ _("Save") }}</button>
      </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}


{% block script %}
    {{ super() }}
    {{ load_bootstrap_table_js("services-table", "networks.service_show", "service_id") }}
    <script nonce="{{ csp_nonce() }}">
        function default_row_style(row, index) {
            return {css: { cursor: 'pointer' }}
          }
        const credentialSocket = io('/credential')
        credentialSocket.on('connect', function () {
            credentialSocket.emit('join_room', '{{ credential.id }}')
        });

        document.getElementById('edit_related_services').addEventListener('click', function() {
            let related_services = Array.from(document.getElementById("{{ edit_related_services.services.id }}").options) // Convert options to an array
            .filter(option => option.selected)      // Filter selected options
            .map(option => option.value);
            credentialSocket.emit('edit related services', {'related_services': related_services});
            bootstrap.Modal.getInstance(document.getElementById('modalEditRelatedServices')).hide();
        });
        credentialSocket.on('change related services', function(data) {
            $(function() {
                $('#services-table').bootstrapTable('load', data.rows);
            })
        });
    </script>
{% endblock %}