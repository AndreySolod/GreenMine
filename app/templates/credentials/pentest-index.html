{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import load_bootstrap_table_js %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block page_content %}
<div class="row gutters">
    <div class="col-12">
        <table class="table" id="credentials-table" data-pagination="true"
                                                    data-search="true"
                                                    data-show-columns="true"
                                                    data-show-toggle="true"
                                                    data-show-export="true"
                                                    data-show-multi-sort="true"
                                                    data-filter-control="true"
                                                    data-buttons-class="primary"
                                                    data-cookie="true"
                                                    data-cookie-id-table="CredentialPentestIndex"
                                                    data-cookie-storage="localStorage">
            <thead>
                <tr>
                    <th data-field="id" data-sortable="true" data-align="center">{{ models.Credential.id.info["label"] }}</th>
                    <th data-field="login" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Credential.login.info["label"] }}</th>
                    <th data-field="password" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Credential.password.info["label"] }}</th>
                    <th data-field="password_hash" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Credential.password_hash.info["label"] }}</th>
                    <th data-field="hash_type" data-sortable="true" data-align="center" data-filter-control="select">{{ models.Credential.hash_type.info["label"] }}</th>
                    <th data-field="check_wordlist" data-sortable="true" data-align="center" data-filter-control="select">{{ models.Credential.check_wordlist.info["label"] }}</th>
                    <th data-field="description" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Credential.description.info["label"] }}</th>
                    <th data-field="service_list" data-sortable="true" data-align="center" data-filter-control="input">{{ models.Credential.services.info["label"] }}</th>
                </tr>
            </thead>
            <tbody>
                {% for credential in credentials %}
                <tr style="cursor:pointer" class="with-context-menu">
                    <td>{{ credential.id }}</td>
                    <td>{{ credential.login }}</td>
                    <td>{{ credential.password }}</td>
                    <td>{{ credential.password_hash }}</td>
                    <td>{{ credential.hash_type.title }}</td>
                    <td>{{ credential.check_wordlist.title }}</td>
                    <td>{{ sanitizer.pure_text(credential.description) }}</td>
                    <td>{{ credential.service_list_as_text }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block script %}
    {{ super() }}
    {{ load_bootstrap_table_js("credentials-table", "credentials.credential_show", "credential_id") }}
    <script nonce="{{ csp_nonce() }}">
        $(function() {
            $.contextMenu({
                selector: '.with-context-menu',
                callback: function(key, options) {
                    if(key == 'open') {
                        window.open("{{ url_for('credentials.credential_show', credential_id='__credential_id') }}".replace("__credential_id", options.$trigger[0].children[0].textContent), '_blank').focus()
                    }
                    else if (key == 'copy_login') {
                        navigator.clipboard.writeText(options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].login);
                    }
                    else if(key == 'copy_password'){
                        navigator.clipboard.writeText(options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].password);
                    }
                    else if(key == 'login_password') {
                        let data = options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')];
                        navigator.clipboard.writeText(data.login + " " + data.password);
                    }
                    else if(key == 'ulogin_upassword') {
                        let data = options.$trigger.parent().parent().bootstrapTable('getData')[options.$trigger.data('index')].id;
                        navigator.clipboard.writeText("-u '" + data.login + "' -p '" + data.password + "'")
                    }
                },
                items: {
                    "open": {name: '{{ _("Open in new tab") }}', icon: "filescroll"},
                    "copy": {
                        name: '{{ _("Copy") }}',
                        items: {
                            "copy_login": {name:'{{ models.Credential.login.info["label"] }}', icon: "usertag"},
                            "copy_password": {name: '{{ models.Credential.password.info["label"] }}', icon: "key"},
                            "login_password": {name: '{{ models.Credential.login.info["label"] }} {{ models.Credential.password.info["label"] }}', icon: "userlock"},
                            "ulogin_upassword": {name: '-u {{ models.Credential.login.info["label"] }} -p {{ models.Credential.password.info["label"] }}', icon: "usergear"}
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}