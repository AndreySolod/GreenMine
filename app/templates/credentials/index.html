{% extends 'layout/base.html' %}
{% from 'layout/_macrosses.html' import bootstrap_table_icons %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block page_content %}
<div class="row gutters">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>{{ _("All credentials") }}</h5>
            </div>
            <div class="card-body">
                <div id="credentials-toolbar">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            {{ _("Export as") }}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a id="special-export-login-button" class="dropdown-item">{{
                                    models.Credential.login.info["label"] }}</a></li>
                            <li><a id="special-export-passsord-button" class="dropdown-item">{{
                                    models.Credential.password.info["label"] }}</a></li>
                            <li><a id="special-export-login-password-button" class="dropdown-item">{{
                                    models.Credential.login.info["label"] }}:{{ models.Credential.password.info["label"]
                                    }}</a></li>
                            <li><a id="special-export-hashes-button" class="dropdown-item">{{
                                    models.Credential.password_hash.info["label"] }}</a></li>
                        </ul>
                    </div>
                </div>
                <table class="table" id="credentials-table" data-pagination="true" data-search="true"
                    data-show-columns="true" data-show-toggle="true" data-show-export="true" data-show-multi-sort="true"
                    data-filter-control="true" data-buttons-class="primary" data-show-pagination-switch="true",
                    data-toolbar="#credentials-toolbar">
                    <thead>
                        <tr>
                            <th data-field="id" data-sortable="true" data-align="center">{{ models.Credential.id.info["label"] }}</th>
                            <th data-field="login" data-sortable="true" data-align="center" data-filter-control="input">
                                {{ models.Credential.login.info["label"] }}</th>
                            <th data-field="password" data-sortable="true" data-align="center"
                                data-filter-control="input">{{ models.Credential.password.info["label"] }}</th>
                            <th data-field="password_hash" data-sortable="true" data-align="center"
                                data-filter-control="input">{{ models.Credential.password_hash.info["label"] }}</th>
                            <th data-field="hash_type" data-sortable="true" data-align="center"
                                data-filter-control="select">{{ models.Credential.hash_type.info["label"] }}</th>
                            <th data-field="check_wordlist" data-sortable="true" data-align="center"
                                data-filter-control="select">{{ models.Credential.check_wordlist.info["label"] }}</th>
                            <th data-field="description" data-sortable="true" data-align="center"
                                data-filter-control="input">{{ models.Credential.description.info["label"] }}</th>
                            <th data-field="service_list" data-sortable="true" data-align="center"
                                data-filter-control="input">{{ models.Credential.services.info["label"] }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for credential in credentials %}
                        <tr style="cursor:pointer" class="with-context-menu">
                            <td>{{ credential.id }}</td>
                            <td>{{ credential.login }}</td>
                            <td>{{ credential.password }}</td>
                            <td>{{ credential.password_hash }}</td>
                            <td>{{ credential.hash_type.title }}</td>
                            <td>{{ credential.check_wordlist.title }}</td>
                            <td>{{ BeautifulSoup(credential.description, "lxml").text }}</td>
                            <td>{{ credential.service_list_as_text }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script nonce="{{ csp_nonce() }}">
    $(function() {
        var CookieName = "CredentialsIndexPageSize";
        $('#credentials-table').bootstrapTable({
                onPreBody: function(data) {

                    var pageSizeCookie = Cookies.get(CookieName);
                    if(isNaN(Number(pageSizeCookie))) {
                        pageSizeCookie = 10;
                    };
                    if (pageSizeCookie != null) {
        
                        var pageSizeInt = parseInt(pageSizeCookie);
                        this.pageSize = pageSizeInt;
                    }
                },
                onPageChange: function(pageNumber, pageSize) {
                    Cookies.set(CookieName, pageSize, { expires: 30, path: window.location.pathname });
                },
                icons: JSON.parse("{{ bootstrap_table_icons().strip() }}"),
                buttonsClass: 'primary',
                exportTypes: ['json', 'xml', 'png', 'csv', 'txt', 'sql', 'doc', 'excel', 'xlsx', 'pdf'],
                onClickRow: function(row, element, field) {
                    location = "{{ url_for('credentials.credential_show', credential_id='__row_id') }}".replace("__row_id", row.id)
                }
              })
    });
</script>
<script nonce="{{ csp_nonce() }}">
    $(function () {
        $.contextMenu({
            selector: '.with-context-menu',
            callback: function (key, options) {
                if (key === 'open') {
                    window.open("{{ url_for('credentials.credential_show', credential_id='__credential_id') }}".replace("__credential_id", options.$trigger[0].children[0].textContent), '_blank').focus()
                }
                else if(key === 'edit') {
                    window.open("{{ url_for('credentials.credential_edit', credential_id='__credential_id') }}".replace('__credential_id', options.$trigger[0].children[0].textContent), '_blank').focus()
                }
                else if (key === 'copy_login') {
                    navigator.clipboard.writeText(options.$trigger[0].children[1].textContent)
                        .then(() => {
                            // Success!
                        })
                }
                else if (key === 'copy_password') {
                    navigator.clipboard.writeText(options.$trigger[0].children[2].textContent)
                }
                else if (key === 'login_password') {
                    navigator.clipboard.writeText(options.$trigger[0].children[1].textContent + " " + options.$trigger[0].children[2].textContent)
                }
                else if (key === 'ulogin_upassword') {
                    navigator.clipboard.writeText("-u '" + options.$trigger[0].children[1].textContent + "' -p '" + options.$trigger[0].children[2].textContent + "'")
                }
                else if (key === 'copy_password_hash') {
                    navigator.clipboard.writeText(options.$trigger[0].children[3].textContent)
                }
            },
            items: {
                "open": { name: '{{ _("Open in new tab") }}', icon: "filescroll" },
                "edit": { name: '{{ _("Edit") }}' , icon: "edit"},
                "copy": {
                    name: '{{ _("Copy") }}',
                    icon: "copy",
                    items: {
                        "copy_login": { name: '{{ models.Credential.login.info["label"] }}', icon: "usertag" },
                        "copy_password": { name: '{{ models.Credential.password.info["label"] }}', icon: "key" },
                        "login_password": { name: '{{ models.Credential.login.info["label"] }} {{ models.Credential.password.info["label"] }}', icon: "userlock" },
                        "ulogin_upassword": { name: '-u {{ models.Credential.login.info["label"] }} -p {{ models.Credential.password.info["label"] }}', icon: "usergear" },
                        "copy_password_hash": { name: '{{ models.Credential.password_hash.info["label"] }}', icon: "hands-bubbles" },
                    }
                }
            }
        });
    });
</script>
<script nonce="{{ csp_nonce() }}">
    function find_position(id_name) {
        let obj = document.getElementById('credentials-table').rows[0].cells
        for (let i = 0; i < obj.length; i++) {
            if (obj[i].getAttribute('data-field') === id_name) {
                return i
            }
        }
    }
    function special_export(export_type) {
        let ignore_columns = [];
        let login_position = find_position('login');
        let password_position = find_position('password');
        let hash_position = find_position('password_hash');
        let filename = '';
        let set_of_data = [];
        let require_unique = true;
        if (export_type === 'logins') {
            ignore_columns = Array.from(Array(document.getElementById('credentials-table').rows[0].cells.length).keys()).filter(item => item !== login_position);
            filename = "Logins from project #{{ project.id }}";
        }
        else if (export_type === 'passwords') {
            ignore_columns = Array.from(Array(document.getElementById('credentials-table').rows[0].cells.length).keys()).filter(item => item !== password_position);
            filename = "Passwords from project #{{ project.id }}";
        }
        else if (export_type === 'logins_passwords') {
            ignore_columns = Array.from(Array(document.getElementById('credentials-table').rows[0].cells.length).keys()).filter(item => (item !== login_position && item !== password_position));
            filename = "Logins and passwords from project #{{ project.id }}";
            require_unique = false;
        }
        else if (export_type === 'hashes') {
            ignore_columns = Array.from(Array(document.getElementById('credentials-table').rows[0].cells.length).keys()).filter(item => item !== hash_position);
            filename = "Hashes from project #{{ project.id }}";
        }
        $('#credentials-table').bootstrapTable('togglePagination').tableExport({
            type: 'txt',
            exportDataType: "all",
            ignoreColumn: ignore_columns,//Ignore the index of a column
            ignoreRow: [0],
            csvSeparator: ':',
            fileName: filename,
            onCellHtmlData: function (cell, row, col, data) {//Process the exported content, customize the content of a row, column, or cell
                if (set_of_data.indexOf(data) >= 0 && require_unique) {
                    return false;
                }
                else {
                    set_of_data.push(data)
                    return data
                }
            },
        })
        $('#credentials-table').bootstrapTable('togglePagination')
    };
    document.getElementById('special-export-login-button').addEventListener('click', function(){
        special_export('logins');
    });
    document.getElementById('special-export-passsord-button').addEventListener('click', function() {
        special_export('passwords');
    });
    document.getElementById('special-export-login-password-button').addEventListener('click', function() {
        special_export('logins_passwords');
    });
    document.getElementById('special-export-hashes-button').addEventListener('click', function() {
        special_export('hashes');
    });
</script>
{% endblock %}