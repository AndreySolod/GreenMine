from app import db
from app.helpers.general_helpers import utcnow, default_string_slug
from app.helpers.admin_helpers import project_enumerated_object, project_object_with_permissions
from .generic import HasComment, HasHistory
from datetime import datetime
import sqlalchemy as sa
import sqlalchemy.orm as so
from flask_babel import lazy_gettext as _l
from typing import List, Optional, Set
from sqlalchemy.ext.hybrid import hybrid_property


@project_enumerated_object
class EvidenceOfEventDetected(db.Model):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    string_slug: so.Mapped[str] = so.mapped_column(sa.String(50), unique=True, index=True, default=default_string_slug, info={'label': _l('Slug')})
    title: so.Mapped[str] = so.mapped_column(sa.String(80), info={'label': _l("Title")})
    is_default: so.Mapped[bool] = so.mapped_column(default=False, info={'label': _l("Is default")})
    
    def __repr__(self):
        return f"EvidenceOfEventDetected(string_slug='{self.string_slug}', title='{self.title}', is_default={self.is_default})"

    class Meta:
        verbose_name = _l("Evidence of event detection")
        verbose_name_plural = _l("Evidences of event detection")
        title_new = _l("Add new evidence of event detection")
        column_index = ['id', 'string_slug', 'title', 'is_default']


@project_enumerated_object
class EvidenceOfEventPrevented(db.Model):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    string_slug: so.Mapped[str] = so.mapped_column(sa.String(50), unique=True, index=True, default=default_string_slug, info={'label': _l('Slug')})
    title: so.Mapped[str] = so.mapped_column(sa.String(80), info={'label': _l("Title")})
    is_default: so.Mapped[bool] = so.mapped_column(default=False, info={'label': _l("Is default")})

    def __repr__(self):
        return f"EvidenceOfEventPrevented(string_slug='{self.string_slug}', title='{self.title}', is_default={self.is_default})"

    class Meta:
        verbose_name = _l("Evidence of event prevention")
        verbose_name_plural = _l("Evidences of event prevention")
        title_new = _l("Add new evidence of event prevention")
        column_index = ['id', 'string_slug', 'title', 'is_default']


@project_enumerated_object
class MitreAttackTactic(db.Model):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    string_slug: so.Mapped[str] = so.mapped_column(sa.String(50), unique=True, index=True, default=default_string_slug, info={'label': _l('Slug')})
    title: so.Mapped[str] = so.mapped_column(sa.String(80), info={'label': _l("Title")})

    @hybrid_property
    def treeselecttitle(self):
        return self.title
    
    def __repr__(self):
        return f"MitreAttackTactic(string_slug='{self.string_slug}', title='{self.title}')"

    class Meta:
        verbose_name = _l("MITRE ATT&CK Tactic")
        verbose_name_plural = _l("MITRE ATT&CK Tactics")
        title_new = _l("Add new MITRE ATT&CK Tactics")
        column_index = ['id', 'string_slug', 'title']


@project_enumerated_object
class MitreAttackTechnique(db.Model):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    string_slug: so.Mapped[str] = so.mapped_column(sa.String(50), unique=True, index=True, default=default_string_slug, info={'label': _l('Slug')})
    title: so.Mapped[str] = so.mapped_column(sa.String(100), info={'label': _l("Title")})
    tactic_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey(MitreAttackTactic.id, ondelete='CASCADE'), info={'label': _l("Tactic")})
    tactic: so.Mapped[MitreAttackTactic] = so.relationship(lazy='select', info={'label': _l("Tactic")})

    @hybrid_property
    def treeselecttitle(self):
        return self.title
    
    def __repr__(self):
        return f"MitreAttackTechnique(string_slug='{self.string_slug}', title='{self.title}', tactic_id={self.tactic_id})"
    
    def parent(self):
        return self.tactic

    class Meta:
        verbose_name = _l("MITRE ATT&CK Technique")
        verbose_name_plural = _l("MITRE ATT&CK Techniques")
        title_new = _l("Add new MITRE ATT&CK Technique")
        column_index = ['id', 'string_slug', 'title', 'tactic']


@project_object_with_permissions
class PentestResearchEvent(db.Model, HasComment, HasHistory):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    created_at: so.Mapped[datetime] = so.mapped_column(default=utcnow, info={'label': _l("Created at")})
    created_by_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('user.id', ondelete='SET NULL'), info={'label': _l("Created by")})
    created_by: so.Mapped["User"] = so.relationship(lazy='select', foreign_keys=[created_by_id], info={'label': _l("Created by")}) # type: ignore
    updated_at: so.Mapped[Optional[datetime]] = so.mapped_column(info={'label': _l("Updated at")})
    updated_by_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('user.id', ondelete='SET NULL'), info={'label': _l("Updated by")})
    updated_by: so.Mapped["User"] = so.relationship(lazy='select', foreign_keys=[updated_by_id], info={'label': _l("Updated by")}) # type: ignore
    title: so.Mapped[str] = so.mapped_column(sa.String(80), info={'label': _l("Title")})
    timestamp: so.Mapped[datetime] = so.mapped_column(default=utcnow, info={'label': _l("Event timestamp")})
    source_host_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('host.id', ondelete='CASCADE'), info={'label': _l("Source host"), 'help_text': _l("Host-the source from which the impact was carried out")})
    source_host: so.Mapped["Host"] = so.relationship(lazy='select', foreign_keys=[source_host_id], info={'label': _l("Source host"), 'help_text': _l("Host-the source from which the impact was carried out")}) # type: ignore
    source_user: so.Mapped[Optional[str]] = so.mapped_column(sa.String(50), info={'label': _l("Source user")})
    source_process: so.Mapped[Optional[str]] = so.mapped_column(sa.String(80), info={'label': _l("Source process")})
    target_host_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('host.id', ondelete='CASCADE'), info={'label': _l("Target host"), 'help_text': _l("The host that was affected")})
    target_host: so.Mapped["Host"] = so.relationship(lazy='select', foreign_keys=[target_host_id], info={'label': _l("Target host"), 'help_text': _l("The host that was affected")}) # type: ignore
    target_user: so.Mapped[Optional[str]] = so.mapped_column(sa.String(50), info={'label': _l("Target user")})
    target_process: so.Mapped[Optional[str]] = so.mapped_column(sa.String(80), info={'label': _l("Target process")})
    operator_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('user.id', ondelete='SET NULL'), info={'label': _l("Operator"), 'help_text': _l("The person who performed the action")})
    operator: so.Mapped["User"] = so.relationship(lazy='select', foreign_keys=[operator_id], info={'label': _l("Operator"), 'help_text': _l("The person who performed the action")}) # type: ignore
    description: so.Mapped[Optional[str]] = so.mapped_column(info={'label': _l("Description")})
    raw_evidence: so.Mapped[Optional[str]] = so.mapped_column(info={'label': _l("Raw evidence")})
    detected_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey(EvidenceOfEventDetected.id, ondelete='SET NULL'), info={'label': _l("Detected"), 'help_text': _l("Evidence of event detection")})
    detected: so.Mapped[EvidenceOfEventDetected] = so.relationship(lazy='select', info={'label': _l("Detected"), 'help_text': _l("Evidence of event detection")})
    prevented_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey(EvidenceOfEventPrevented.id, ondelete='SET NULL'), info={'label': _l("Prevented"), 'help_text': _l("Evidence of event prevention")})
    prevented: so.Mapped[EvidenceOfEventPrevented] = so.relationship(lazy='select', info={'label': _l("Prevented"), 'help_text': _l("Evidence of event prevention")})
    mitre_attack_technique_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey(MitreAttackTechnique.id, ondelete='SET NULL'), info={'label': _l("MITRE ATT&CK Technique")})
    mitre_attack_technique: so.Mapped[MitreAttackTechnique] = so.relationship(lazy='select', info={'label': _l("MITRE ATT&CK Technique")})
    project_id: so.Mapped[int] = so.mapped_column(sa.ForeignKey('project.id', ondelete='CASCADE'), info={'label': _l("Project")})
    project: so.Mapped["Project"] = so.relationship(lazy='select', info={'label': _l("Project")}) # type: ignore
    next_events: so.Mapped[Optional[Set["PentestResearchEvent"]]] = so.relationship(secondary="pentest_event_chain",
                                                                              primaryjoin="PentestResearchEvent.id==PentestEventChain.from_event_id",
                                                                              secondaryjoin="PentestEventChain.to_event_id==PentestResearchEvent.id",
                                                                              back_populates="follow_from_events", lazy="select", info={'label': _l("Next events")})
    follow_from_events: so.Mapped[Optional[Set["PentestResearchEvent"]]] = so.relationship(secondary="pentest_event_chain",
                                                                                        primaryjoin="PentestResearchEvent.id==PentestEventChain.to_event_id",
                                                                                        secondaryjoin="PentestEventChain.from_event_id==PentestResearchEvent.id",
                                                                                        back_populates="next_events", lazy="select", info={'label': _l("Previous events")})
    
    @property
    def treeselecttitle(self):
        return self.title

    class Meta:
        verbose_name = _l("Research event")
        verbose_name_plural = _l("Research events")
        icon = "fa-solid fa-eye"
        project_permission_actions = {'index': _l("Show object list"), 'create': _l("Create new object"), 'show': _l("Show object card"),
                                      'update': _l("Edit and update object"), 'delete': _l("Delete object"), 'add_comment': _l("Add comment to object"),
                                      'show_comments': _l("Show comment list of object"), 'show_history': _l("Show object history"), 'show_timeline': _l("Show object list in timeline"),
                                      'pentest_chain': _l("Show pentest action chain")}


class PentestEventChain(db.Model):
    from_event_id: so.Mapped[int] = so.mapped_column(sa.ForeignKey(PentestResearchEvent.id, ondelete='CASCADE'), primary_key=True)
    to_event_id: so.Mapped[int] = so.mapped_column(sa.ForeignKey(PentestResearchEvent.id, ondelete='CASCADE'), primary_key=True)


@project_object_with_permissions
class PentestOrganizationDetectionEvent(db.Model, HasComment, HasHistory):
    id: so.Mapped[int] = so.mapped_column(primary_key=True, info={'label': _l("ID")})
    title: so.Mapped[str] = so.mapped_column(sa.String(80), info={'label': _l("Title")})
    created_at: so.Mapped[datetime] = so.mapped_column(default=utcnow, info={'label': _l("Created at")})
    created_by_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('user.id', ondelete='SET NULL'), info={'label': _l("Created by")})
    created_by: so.Mapped["User"] = so.relationship(lazy='select', foreign_keys=[created_by_id], info={'label': _l("Created by")}) # type: ignore
    updated_at: so.Mapped[Optional[datetime]] = so.mapped_column(info={'label': _l("Updated at")})
    updated_by_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('user.id', ondelete='SET NULL'), info={'label': _l("Updated by")})
    updated_by: so.Mapped["User"] = so.relationship(lazy='select', foreign_keys=[updated_by_id], info={'label': _l("Updated by")}) # type: ignore
    timestamp: so.Mapped[datetime] = so.mapped_column(default=utcnow, info={'label': _l("Event timestamp")})
    source_host_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('host.id', ondelete='CASCADE'), info={'label': _l("Source host")})
    source_host: so.Mapped["Host"] = so.relationship(lazy='select', foreign_keys=[source_host_id], info={'label': _l("Source host")}) # type: ignore
    source_user: so.Mapped[Optional[str]] = so.mapped_column(sa.String(50), info={'label': _l("Source user")})
    source_process: so.Mapped[Optional[str]] = so.mapped_column(sa.String(80), info={'label': _l("Source process")})
    target_host_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey('host.id', ondelete='CASCADE'), info={'label': _l("Target host")})
    target_host: so.Mapped["Host"] = so.relationship(lazy='select', foreign_keys=[target_host_id], info={'label': _l("Target host")}) # type: ignore
    target_user: so.Mapped[Optional[str]] = so.mapped_column(sa.String(50), info={'label': _l("Target user")})
    target_process: so.Mapped[Optional[str]] = so.mapped_column(sa.String(80), info={'label': _l("Target process")})
    description: so.Mapped[Optional[str]] = so.mapped_column(info={'label': _l("Description")})
    mitre_attack_technique_id: so.Mapped[Optional[int]] = so.mapped_column(sa.ForeignKey(MitreAttackTechnique.id, ondelete='SET NULL'), info={'label': _l("MITRE ATT&CK Technique")})
    mitre_attack_technique: so.Mapped[MitreAttackTechnique] = so.relationship(lazy='select', info={'label': _l("MITRE ATT&CK Technique")})
    project_id: so.Mapped[int] = so.mapped_column(sa.ForeignKey('project.id', ondelete='CASCADE'), info={'label': _l("Project")})
    project: so.Mapped["Project"] = so.relationship(lazy='select', info={'label': _l("Project")}) # type: ignore

    class Meta:
        verbose_name = _l("Organization Detection Event")
        verbose_name_plural = _l("Organization Detection Events")
        icon = "fa-solid fa-fingerprint"
        project_permission_actions = {'index': _l("Show object list"), 'create': _l("Create new object"), 'show': _l("Show object card"),
                                      'update': _l("Edit and update object"), 'delete': _l("Delete object"), 'add_comment': _l("Add comment to object"),
                                      'show_comments': _l("Show comment list of object"), 'show_history': _l("Show object history"), 'show_timeline': _l("Show object list in timeline")}